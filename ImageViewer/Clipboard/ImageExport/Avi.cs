#region License (non-CC)

// This software is licensed un the Code Project Open License 1.02,
// the terms of which are listed as follows.
//
// Preamble
//
// This License governs Your use of the Work. This License is intended to allow
// developers to use the Source Code and Executable Files provided as part of the
// Work in any application in any form.
//
// The main points subject to the terms of the License are:
//
//   * Source Code and Executable Files can be used in commercial applications;
//   * Source Code and Executable Files can be redistributed; and
//   * Source Code can be modified to create derivative works.
//   * No claim of suitability, guarantee, or any warranty whatsoever is provided.
//     The software is provided "as-is".
//   * The Article(s) accompanying the Work may not be distributed or republished
//     without the Author's consent
//
// This License is entered between You, the individual or other entity reading or
// otherwise making use of the Work licensed pursuant to this License and the
// individual or other entity which offers the Work under the terms of this License
// ("Author").
//
// License
//
// THE WORK (AS DEFINED BELOW) IS PROVIDED UNDER THE TERMS OF THIS CODE PROJECT
// OPEN LICENSE ("LICENSE"). THE WORK IS PROTECTED BY COPYRIGHT AND/OR OTHER
// APPLICABLE LAW. ANY USE OF THE WORK OTHER THAN AS AUTHORIZED UNDER THIS LICENSE
// OR COPYRIGHT LAW IS PROHIBITED.
//
// BY EXERCISING ANY RIGHTS TO THE WORK PROVIDED HEREIN, YOU ACCEPT AND AGREE TO BE
// BOUND BY THE TERMS OF THIS LICENSE. THE AUTHOR GRANTS YOU THE RIGHTS CONTAINED
// HEREIN IN CONSIDERATION OF YOUR ACCEPTANCE OF SUCH TERMS AND CONDITIONS. IF YOU
// DO NOT AGREE TO ACCEPT AND BE BOUND BY THE TERMS OF THIS LICENSE, YOU CANNOT
// MAKE ANY USE OF THE WORK.
//
//   1. Definitions.
//      1. "Articles" means, collectively, all articles written by Author which
//         describes how the Source Code and Executable Files for the Work may be
//         used by a user.
//      2. "Author" means the individual or entity that offers the Work under the
//         terms of this License.
//      3. "Derivative Work" means a work based upon the Work or upon the Work and
//         other pre-existing works.
//      4. "Executable Files" refer to the executables, binary files, configuration
//         and any required data files included in the Work.
//      5. "Publisher" means the provider of the website, magazine, CD-ROM, DVD or
//         other medium from or by which the Work is obtained by You.
//      6. "Source Code" refers to the collection of source code and configuration
//         files used to create the Executable Files.
//      7. "Standard Version" refers to such a Work if it has not been modified, or
//         has been modified in accordance with the consent of the Author, such
//         consent being in the full discretion of the Author.
//      8. "Work" refers to the collection of files distributed by the Publisher,
//         including the Source Code, Executable Files, binaries, data files,
//         documentation, whitepapers and the Articles.
//      9. "You" is you, an individual or entity wishing to use the Work and
//         exercise your rights under this License.
//   2. Fair Use/Fair Use Rights. Nothing in this License is intended to reduce,
//      limit, or restrict any rights arising from fair use, fair dealing, first
//      sale or other limitations on the exclusive rights of the copyright owner
//      under copyright law or other applicable laws.
//   3. License Grant. Subject to the terms and conditions of this License, the
//      Author hereby grants You a worldwide, royalty-free, non-exclusive,
//      perpetual (for the duration of the applicable copyright) license to
//      exercise the rights in the Work as stated below:
//      1. You may use the standard version of the Source Code or Executable Files
//         in Your own applications.
//      2. You may apply bug fixes, portability fixes and other modifications
//         obtained from the Public Domain
//         or from the Author. A Work modified in such a way shall still be
//         considered the standard version and will be subject to this License.
//      3. You may otherwise modify Your copy of this Work (excluding the Articles)
//         in any way to create a Derivative Work, provided that You insert a
//         prominent notice in each changed file stating how, when and where You
//         changed that file.
//      4. You may distribute the standard version of the Executable Files and
//         Source Code or Derivative Work in aggregate with other (possibly
//         commercial) programs as part of a larger (possibly commercial) software
//         distribution.
//      5. The Articles discussing the Work published in any form by the author may
//         not be distributed or republished without the Author's consent. The
//         author retains copyright to any such Articles. You may use the
//         Executable Files and Source Code pursuant to this License but you may
//         not repost or republish or otherwise distribute or make available the
//         Articles, without the prior written consent of the Author. Any
//         subroutines or modules supplied by You and linked into the Source Code
//         or Executable Files this Work shall not be considered part of this Work
//         and will not be subject to the terms of this License.
//   4. Patent License. Subject to the terms and conditions of this License, each
//      Author hereby grants to You a perpetual, worldwide, non-exclusive,
//      no-charge, royalty-free, irrevocable (except as stated in this section)
//      patent license to make, have made, use, import, and otherwise transfer the
//      Work.
//   5. Restrictions. The license granted in Section 3 above is expressly made
//      subject to and limited by the following restrictions:
//      1. You agree not to remove any of the original copyright, patent,
//         trademark, and attribution notices and associated disclaimers that may
//         appear in the Source Code or Executable Files.
//      2. You agree not to advertise or in any way imply that this Work is a
//         product of Your own.
//      3. The name of the Author may not be used to endorse or promote products
//         derived from the Work without the prior written consent of the Author.
//      4. You agree not to sell, lease, or rent any part of the Work. This does
//         not restrict you from including the Work or any part of the Work inside
//         a larger software distribution that itself is being sold. The Work by
//         itself, though, cannot be sold, leased or rented.
//      5. You may distribute the Executable Files and Source Code only under the
//         terms of this License, and You must include a copy of, or the Uniform
//         Resource Identifier for, this License with every copy of the Executable
//         Files or Source Code You distribute and ensure that anyone receiving
//         such Executable Files and Source Code agrees that the terms of this
//         License apply to such Executable Files and/or Source Code. You may not
//         offer or impose any terms on the Work that alter or restrict the terms
//         of this License or the recipients' exercise of the rights granted
//         hereunder. You may not sublicense the Work. You must keep intact all
//         notices that refer to this License and to the disclaimer of warranties.
//         You may not distribute the Executable Files or Source Code with any
//         technological measures that control access or use of the Work in a
//         manner inconsistent with the terms of this License.
//      6. You agree not to use the Work for illegal, immoral or improper purposes,
//         or on pages containing illegal, immoral or improper material. The Work
//         is subject to applicable export laws. You agree to comply with all such
//         laws and regulations that may apply to the Work after Your receipt of
//         the Work.
//   6. Representations, Warranties and Disclaimer. THIS WORK IS PROVIDED "AS IS",
//      "WHERE IS" AND "AS AVAILABLE", WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES OR
//      CONDITIONS OR GUARANTEES. YOU, THE USER, ASSUME ALL RISK IN ITS USE,
//      INCLUDING COPYRIGHT INFRINGEMENT, PATENT INFRINGEMENT, SUITABILITY, ETC.
//      AUTHOR EXPRESSLY DISCLAIMS ALL EXPRESS, IMPLIED OR STATUTORY WARRANTIES OR
//      CONDITIONS, INCLUDING WITHOUT LIMITATION, WARRANTIES OR CONDITIONS OF
//      MERCHANTABILITY, MERCHANTABLE QUALITY OR FITNESS FOR A PARTICULAR PURPOSE,
//      OR ANY WARRANTY OF TITLE OR NON-INFRINGEMENT, OR THAT THE WORK (OR ANY
//      PORTION THEREOF) IS CORRECT, USEFUL, BUG-FREE OR FREE OF VIRUSES. YOU MUST
//      PASS THIS DISCLAIMER ON WHENEVER YOU DISTRIBUTE THE WORK OR DERIVATIVE
//      WORKS.
//   7. Indemnity. You agree to defend, indemnify and hold harmless the Author and
//      the Publisher from and against any claims, suits, losses, damages,
//      liabilities, costs, and expenses (including reasonable legal or attorneys'
//      fees) resulting from or relating to any use of the Work by You.
//   8. Limitation on Liability. EXCEPT TO THE EXTENT REQUIRED BY APPLICABLE LAW,
//      IN NO EVENT WILL THE AUTHOR OR THE PUBLISHER BE LIABLE TO YOU ON ANY LEGAL
//      THEORY FOR ANY SPECIAL, INCIDENTAL, CONSEQUENTIAL, PUNITIVE OR EXEMPLARY
//      DAMAGES ARISING OUT OF THIS LICENSE OR THE USE OF THE WORK OR OTHERWISE,
//      EVEN IF THE AUTHOR OR THE PUBLISHER HAS BEEN ADVISED OF THE POSSIBILITY OF
//      SUCH DAMAGES.
//   9. Termination.
//      1. This License and the rights granted hereunder will terminate
//         automatically upon any breach by You of any term of this License.
//         Individuals or entities who have received Derivative Works from You
//         under this License, however, will not have their licenses terminated
//         provided such individuals or entities remain in full compliance with
//         those licenses. Sections 1, 2, 6, 7, 8, 9, 10 and 11 will survive any
//         termination of this License.
//      2. If You bring a copyright, trademark, patent or any other infringement
//         claim against any contributor over infringements You claim are made by
//         the Work, your License from such contributor to the Work ends
//         automatically.
//      3. Subject to the above terms and conditions, this License is perpetual
//         (for the duration of the applicable copyright in the Work).
//         Notwithstanding the above, the Author reserves the right to release the
//         Work under different license terms or to stop distributing the Work at
//         any time; provided, however that any such election will not serve to
//         withdraw this License (or any other license that has been, or is
//         required to be, granted under the terms of this License), and this
//         License will continue in full force and effect unless terminated as
//         stated above.
//   10. Publisher. The parties hereby confirm that the Publisher shall not, under
//       any circumstances, be responsible for and shall not have any liability in
//       respect of the subject matter of this License. The Publisher makes no
//       warranty whatsoever in connection with the Work and shall not be liable to
//       You or any party on any legal theory for any damages whatsoever, including
//       without limitation any general, special, incidental or consequential
//       damages arising in connection to this license. The Publisher reserves the
//       right to cease making the Work available to You at any time without notice.
//   11. Miscellaneous
//       1. This License shall be governed by the laws of the location of the head
//          office of the Author or if the Author is an individual, the laws of
//          location of the principal place of residence of the Author.
//       2. If any provision of this License is invalid or unenforceable under
//          applicable law, it shall not affect the validity or enforceability of
//          the remainder of the terms of this License, and without further action
//          by the parties to this License, such provision shall be reformed to the
//          minimum extent necessary to make such provision valid and enforceable.
//       3. No term or provision of this License shall be deemed waived and no
//          breach consented to unless such waiver or consent shall be in writing
//          and signed by the party to be charged with such waiver or consent.
//       4. This License constitutes the entire agreement between the parties with
//          respect to the Work licensed herein. There are no understandings,
//          agreements or representations with respect to the Work not specified
//          herein. The Author shall not be bound by any additional provisions that
//          may appear in any communication from You. This License may not be
//          modified without the mutual written agreement of the Author and You.

#endregion

/* Adapted from CodeProject: http://www.codeproject.com/KB/audio-video/avifilewrapper.aspx
 * Thanks to:
 * 
 * Corinna John (Hannover, Germany)
 * cj@binary-universe.net
 * 
 * for making her code publicly available.
 */

using System;
using System.Runtime.InteropServices;


namespace ClearCanvas.ImageViewer.Clipboard.ImageExport
{

	internal partial class Avi{

		public static int PALETTE_SIZE = 4*256; //RGBQUAD * 256 colours

		public static readonly int streamtypeVIDEO = mmioFOURCC('v', 'i', 'd', 's');
		public static readonly int streamtypeAUDIO = mmioFOURCC('a', 'u', 'd', 's');
		public static readonly int streamtypeMIDI = mmioFOURCC('m', 'i', 'd', 's');
		public static readonly int streamtypeTEXT = mmioFOURCC('t', 'x', 't', 's');
		
		public const int OF_SHARE_DENY_WRITE = 32;
		public const int OF_WRITE			 = 1;
		public const int OF_READWRITE		 = 2;
		public const int OF_CREATE			 = 4096;

		public const int BMP_MAGIC_COOKIE = 19778; //ascii string "BM"

		public const int AVICOMPRESSF_INTERLEAVE = 0x00000001;    // interleave
		public const int AVICOMPRESSF_DATARATE = 0x00000002;    // use a data rate
		public const int AVICOMPRESSF_KEYFRAMES = 0x00000004;    // use keyframes
		public const int AVICOMPRESSF_VALID = 0x00000008;    // has valid data
		public const int AVIIF_KEYFRAME = 0x00000010;

		public const UInt32 ICMF_CHOOSE_KEYFRAME = 0x0001;	// show KeyFrame Every box
		public const UInt32 ICMF_CHOOSE_DATARATE = 0x0002;	// show DataRate box
		public const UInt32 ICMF_CHOOSE_PREVIEW  = 0x0004;	// allow expanded preview dialog

        //macro mmioFOURCC
        public static Int32 mmioFOURCC(char ch0, char ch1, char ch2, char ch3) {
            return ((Int32)(byte)(ch0) | ((byte)(ch1) << 8) |
                ((byte)(ch2) << 16) | ((byte)(ch3) << 24));
        }

		public static string mmioFourCCToString(Int32 code)
		{
			char[] values = new char[4];
			values[0] = (char)((code & 0x000000ff));
			values[1] = (char)((code & 0x0000ff00) >> 8);
			values[2] = (char)((code & 0x00ff0000) >> 16);
			values[3] = (char)((code & 0xff000000) >> 24);

			return new String(values);
		}

		#region structure declarations

		[StructLayout(LayoutKind.Sequential, Pack=1)]
		public struct RECT{ 
			public Int32 left; 
			public Int32 top; 
			public Int32 right; 
			public Int32 bottom; 
		} 		

		[StructLayout(LayoutKind.Sequential, Pack=1)]
		public struct BITMAPINFOHEADER {
			public Int32 biSize;
			public Int32 biWidth;
			public Int32 biHeight;
			public Int16 biPlanes;
			public Int16 biBitCount;
			public Int32 biCompression;
			public Int32 biSizeImage;
			public Int32 biXPelsPerMeter;
			public Int32 biYPelsPerMeter;
			public Int32 biClrUsed;
			public Int32 biClrImportant;
		}

		[StructLayout(LayoutKind.Sequential)] 
		public struct PCMWAVEFORMAT {
			public short wFormatTag;
			public short nChannels;
			public int nSamplesPerSec;
			public int nAvgBytesPerSec;
			public short nBlockAlign;
			public short wBitsPerSample;
			public short cbSize;
		}

		[StructLayout(LayoutKind.Sequential, Pack=1)]
		public struct AVISTREAMINFO {
			public Int32    fccType;
			public Int32    fccHandler;
			public Int32    dwFlags;
			public Int32    dwCaps;
			public Int16    wPriority;
			public Int16    wLanguage;
			public Int32    dwScale;
			public Int32    dwRate;
			public Int32    dwStart;
			public Int32    dwLength;
			public Int32    dwInitialFrames;
			public Int32    dwSuggestedBufferSize;
			public Int32    dwQuality;
			public Int32    dwSampleSize;
			public RECT		rcFrame;
			public Int32    dwEditCount;
			public Int32    dwFormatChangeCount;
			[MarshalAs(UnmanagedType.ByValArray, SizeConst=64)]
			public UInt16[]    szName;
		}
		[StructLayout(LayoutKind.Sequential, Pack=1)]
		public struct BITMAPFILEHEADER{
			public Int16 bfType; //"magic cookie" - must be "BM"
			public Int32 bfSize;
			public Int16 bfReserved1;
			public Int16 bfReserved2;
			public Int32 bfOffBits;
		}

				
		[StructLayout(LayoutKind.Sequential, Pack=1)]
			public struct AVIFILEINFO{
			public Int32 dwMaxBytesPerSecond;
			public Int32 dwFlags;
			public Int32 dwCaps;
			public Int32 dwStreams;
			public Int32 dwSuggestedBufferSize;
			public Int32 dwWidth;
			public Int32 dwHeight;
			public Int32 dwScale;
			public Int32 dwRate;
			public Int32 dwLength;
			public Int32 dwEditCount;
			[MarshalAs(UnmanagedType.ByValArray, SizeConst=64)]
			public char[] szFileType;
		}

		[StructLayout(LayoutKind.Sequential, Pack=1)]
			public struct AVICOMPRESSOPTIONS {
			public Int32   fccType;
			public Int32   fccHandler;
			public Int32   dwKeyFrameEvery;  // only used with AVICOMRPESSF_KEYFRAMES
			public Int32   dwQuality;
			public Int32   dwBytesPerSecond; // only used with AVICOMPRESSF_DATARATE
			public Int32   dwFlags;
			public IntPtr   lpFormat;
			public Int32   cbFormat;
			public IntPtr   lpParms;
			public Int32   cbParms;
			public Int32   dwInterleaveEvery;
		}

		/// <summary>AviSaveV needs a pointer to a pointer to an AVICOMPRESSOPTIONS structure</summary>
		[StructLayout(LayoutKind.Sequential, Pack=1)]
			public class AVICOMPRESSOPTIONS_CLASS {
			public Int32   fccType;
			public Int32   fccHandler;
			public Int32   dwKeyFrameEvery;  // only used with AVICOMRPESSF_KEYFRAMES
			public Int32   dwQuality;
			public Int32   dwBytesPerSecond; // only used with AVICOMPRESSF_DATARATE
			public Int32   dwFlags;
			public IntPtr   lpFormat;
			public Int32   cbFormat;
			public IntPtr   lpParms;
			public Int32   cbParms;
			public Int32   dwInterleaveEvery;

			public AVICOMPRESSOPTIONS ToStruct(){
				AVICOMPRESSOPTIONS returnVar = new AVICOMPRESSOPTIONS();
				returnVar.fccType = this.fccType;
				returnVar.fccHandler = this.fccHandler;
				returnVar.dwKeyFrameEvery = this.dwKeyFrameEvery;
				returnVar.dwQuality = this.dwQuality;
				returnVar.dwBytesPerSecond = this.dwBytesPerSecond;
				returnVar.dwFlags = this.dwFlags;
				returnVar.lpFormat = this.lpFormat;
				returnVar.cbFormat = this.cbFormat;
				returnVar.lpParms = this.lpParms;
				returnVar.cbParms = this.cbParms;
				returnVar.dwInterleaveEvery = this.dwInterleaveEvery;
				return returnVar;
			}
		}

		#endregion structure declarations

		#region method declarations
	
		//Initialize the AVI library
		[DllImport("avifil32.dll")]
		public static extern void AVIFileInit();

		//Open an AVI file
		[DllImport("avifil32.dll", PreserveSig=true)]
		public static extern int AVIFileOpen(
            out IntPtr ppfile,
			String szFile,
			int uMode,
			int pclsidHandler);

		//Create a new stream in an open AVI file
		[DllImport("avifil32.dll")]
		public static extern int AVIFileCreateStream(
			IntPtr pfile,
			out IntPtr ppavi, 
			ref AVISTREAMINFO ptr_streaminfo);

        //Set the format for a new stream
		[DllImport("avifil32.dll")]
		public static extern int AVIStreamSetFormat(
			IntPtr aviStream, Int32 lPos, 
			ref BITMAPINFOHEADER lpFormat, Int32 cbFormat);
		
		//Set the format for a new stream
		[DllImport("avifil32.dll")]
		public static extern int AVIStreamSetFormat(
			IntPtr aviStream, Int32 lPos, 
			ref PCMWAVEFORMAT lpFormat, Int32 cbFormat);
		
		//Write a sample to a stream
		[DllImport("avifil32.dll")]
		public static extern int AVIStreamWrite(
			IntPtr aviStream, Int32 lStart, Int32 lSamples, 
			IntPtr lpBuffer, Int32 cbBuffer, Int32 dwFlags, 
			Int32 dummy1, Int32 dummy2);

		//Release an open AVI stream
		[DllImport("avifil32.dll")]
		public static extern int AVIStreamRelease(IntPtr aviStream);

		//Release an open AVI file
		[DllImport("avifil32.dll")]
        public static extern int AVIFileRelease(IntPtr pfile);

		//Close the AVI library
		[DllImport("avifil32.dll")]
		public static extern void AVIFileExit();

		[DllImport("avifil32.dll")]
		public static extern int AVIMakeCompressedStream(
			out IntPtr ppsCompressed, IntPtr aviStream, 
			ref AVICOMPRESSOPTIONS ao, int dummy);

		[DllImport("winmm.dll", EntryPoint="mmioStringToFOURCCA")]
		public static extern int mmioStringToFOURCC(String sz, int uFlags);

		#endregion method declarations

		#region Video Compression Manager

		[StructLayout(LayoutKind.Sequential, Pack = 1)]
		public struct ICINFO
		{
			public Int32 dwSize;
			public Int32 fccType;
			public Int32 fccHandler;
			public Int32 dwFlags;
			public Int32 dwVersion;
			public Int32 dwVersionICM;
			[MarshalAs(UnmanagedType.ByValArray, SizeConst = 16)]
			public UInt16[] szName;
			[MarshalAs(UnmanagedType.ByValArray, SizeConst = 128)]
			public UInt16[] szDescription;
			[MarshalAs(UnmanagedType.ByValArray, SizeConst = 128)]
			public UInt16[] szDriver;
		}; 

		[Flags]
		public enum ICInfoFlags
		{
			VIDCF_QUALITY = 0x0001, // supports quality
			VIDCF_CRUNCH = 0x0002, // supports crunching to a frame size
			VIDCF_TEMPORAL = 0x0004, // supports inter-frame compress
			VIDCF_COMPRESSFRAMES = 0x0008, // wants the compress all frames message
			VIDCF_DRAW = 0x0010, // supports drawing
			VIDCF_FASTTEMPORALC = 0x0020, // does not need prev frame on compress
			VIDCF_FASTTEMPORALD = 0x0080 // does not need prev frame on decompress
		}

		[DllImport("msvfw32.dll")]
		public static extern int ICInfo(
			Int32 fccType,
			Int32 fccHandler,
			ref ICINFO icInfo);

		[DllImport("msvfw32.dll")]
		public static extern IntPtr ICOpen(
			Int32 fccType,
			Int32 fccHandler,
			Int32 wMode
			);

		[DllImport("msvfw32.dll")]
		public static extern Int32 ICClose(IntPtr hic);

		[Flags]
		public enum ICModeFlags
		{
			ICMODE_COMPRESS = 1,
			ICMODE_DECOMPRESS = 2,
			ICMODE_FASTDECOMPRESS = 3,
			ICMODE_QUERY = 4,
			ICMODE_FASTCOMPRESS = 5,
			ICMODE_DRAW = 8
		}

		[DllImport("msvfw32.dll")]
		public static extern Int32 ICGetInfo(IntPtr hic, ref ICINFO picinfo, Int32 size);

		[DllImport("msvfw32.dll")]
		public static extern IntPtr ICLocate(
		  Int32 fccType,
		  Int32 fccHandler,
		  ref BITMAPINFOHEADER lpbiIn,
		  IntPtr lpbiOut,
		  Int16 wFlags);

		#endregion
	}
}
